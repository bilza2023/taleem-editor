<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Taleem Player</title>

  <!-- Player Styles -->
  <link rel="stylesheet" href="./player/css/app/app.css" />
  <link rel="stylesheet" href="./player/taleem-player-app.css" />
  <link rel="stylesheet" href="./player/css/themes/default.css" />

  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: system-ui, sans-serif;
    }
    .load-screen {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  gap: 1.2rem;
}

.load-screen button {
  padding: 0.9rem 2.2rem;
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 0.4px;

  background: linear-gradient(145deg, #1e1e1e, #161616);
  color: white;

  border: 1px solid #2a2a2a;
  border-radius: 8px;

  cursor: pointer;

  transition: all 0.18s ease;
  box-shadow:
    0 4px 14px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255,255,255,0.04);
}

.load-screen button:hover {
  transform: translateY(-2px);
  border-color: #3a3a3a;
  box-shadow:
    0 6px 20px rgba(0,0,0,0.6),
    inset 0 1px 0 rgba(255,255,255,0.06);
}

.load-screen button:active {
  transform: translateY(0);
  box-shadow:
    0 2px 8px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255,255,255,0.03);
}

    #app {
      display: none;
    }

    .nav-test {
      display: none;
    }
  </style>
</head>

<body>

  <!-- Load Screen -->
  <div class="load-screen">
    <button id="openBtn">Load Deck</button>
    <input type="file" id="fileInput" accept=".json" hidden />
  </div>

  <!-- Player Mount -->
  <div id="app"></div>

  <!-- Player Controls -->
  <div class="nav-test">
    <button id="play-btn">‚ñ∂</button>
    <button id="pause-btn">‚è∏</button>
    <button id="stop-btn">‚èπ</button>
    <span id="time">0.0s</span>
    <div class="scrub-wrap">
      <input id="scrub" type="range" min="0" max="1" step="0.1" />
    </div>
  </div>
  <script type="module">
    import {
      createTaleemPlayer,
      resolveAssetPaths,
      resolveBackground,
      getDeckEndTime,
      createSilentTimer,
      startLoop
    } from "./player/taleem-player-app.js";
  
    const openBtn = document.getElementById("openBtn");
    const fileInput = document.getElementById("fileInput");
  
    openBtn.addEventListener("click", () => {
      fileInput.click();
    });
  
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
  
      let parsed;
  
      try {
        const text = await file.text();
        parsed = JSON.parse(text);
      } catch {
        alert("Invalid JSON file.");
        return;
      }
  
      let deckObject;
  
      // Support raw slide array OR full deck object
      if (Array.isArray(parsed)) {
        deckObject = {
          version: "deck-v1",
          name: file.name.replace(".json", ""),
          background: {},
          deck: parsed
        };
      } else if (parsed.deck && Array.isArray(parsed.deck)) {
        deckObject = parsed;
      } else {
        alert("Invalid deck format.");
        return;
      }
  
      startPlayer(deckObject);
    });
  
    /* ===============================
       üîµ ASSET PATH HANDLING
    =============================== */
  
    function obtainAssetsPath() {
      const stored = localStorage.getItem("taleem-user-content-url");
  
      if (stored && stored.trim() !== "") {
        return stored.trim().replace(/\/$/, "");
      }
  
      return "";
    }
  
    function patchDeck(deckObject) {
      const CONTENT_BASE = obtainAssetsPath();
  
      const basePath = CONTENT_BASE
        ? `${CONTENT_BASE}/images/`
        : "images/"; // fallback to local images folder
  
      console.log("basePath",basePath);  
      resolveAssetPaths(deckObject, basePath);
      resolveBackground(deckObject, basePath);
    }
  
    /* ===============================
       üîµ PLAYER START
    =============================== */
  
    function startPlayer(deckObject) {
  
      // Hide load screen
      document.querySelector(".load-screen").style.display = "none";
  
      // Show player + controls
      document.getElementById("app").style.display = "block";
      document.querySelector(".nav-test").style.display = "flex";
  
      // üî• Patch assets BEFORE rendering
      patchDeck(deckObject);
      console.log("deckObject",deckObject);
      const timer = createSilentTimer();
  
      const player = createTaleemPlayer({
        mount: "#app",
        deck: deckObject
      });
  
      const duration = getDeckEndTime(deckObject);
  
      startLoop({
        player,
        timer,
        duration,
        ui: {
          playBtn: document.getElementById("play-btn"),
          pauseBtn: document.getElementById("pause-btn"),
          stopBtn: document.getElementById("stop-btn"),
          scrub: document.getElementById("scrub"),
          timeEl: document.getElementById("time")
        }
      });
    }
  </script>

</body>
</html>